<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pipeline â€” Outreach CRM</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â—†</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #0B0D13;
  --bg-base: #10121A;
  --bg-surface: #161822;
  --bg-raised: #1C1F2B;
  --bg-hover: #222636;
  --border: #252938;
  --border-light: #2E3348;
  --text-primary: #ECEEF4;
  --text-secondary: #A0A5BA;
  --text-muted: #636882;
  --accent: #E8A427;
  --accent-dim: rgba(232,164,39,0.12);
  --accent-border: rgba(232,164,39,0.3);
  --blue: #4B8BF5;
  --blue-dim: rgba(75,139,245,0.12);
  --linkedin: #0A66C2;
  --green: #22C55E;
  --green-dim: rgba(34,197,94,0.12);
  --red: #EF4444;
  --red-dim: rgba(239,68,68,0.12);
  --purple: #A78BFA;
  --pink: #EC4899;
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 14px;
  --font: 'Outfit', -apple-system, sans-serif;
  --mono: 'IBM Plex Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font);
  background: var(--bg-deep);
  color: var(--text-secondary);
  overflow: hidden;
  height: 100vh;
}

::selection { background: var(--accent); color: #000; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

input, select, textarea, button { font-family: var(--font); }

/* â•â•â• LAYOUT â•â•â• */
.app { display: flex; height: 100vh; }

.sidebar {
  width: 230px;
  background: var(--bg-base);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 18px 0;
  flex-shrink: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 20px;
  margin-bottom: 30px;
}
.logo-icon { font-size: 22px; color: var(--accent); }
.logo-text { font-size: 20px; font-weight: 900; color: var(--text-primary); letter-spacing: -0.03em; }

.nav { display: flex; flex-direction: column; gap: 2px; padding: 0 10px; flex: 1; }

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
  width: 100%;
}
.nav-item:hover { background: var(--bg-surface); color: var(--text-secondary); }
.nav-item.active { background: var(--bg-raised); color: var(--text-primary); }
.nav-icon { font-size: 16px; width: 22px; text-align: center; flex-shrink: 0; }
.nav-count {
  margin-left: auto;
  font-size: 11px;
  font-weight: 700;
  background: var(--bg-hover);
  color: var(--text-muted);
  padding: 2px 7px;
  border-radius: 10px;
}
.nav-count.alert { background: var(--accent); color: #000; }

.overdue-alert {
  margin: 0 14px 14px;
  padding: 9px 12px;
  background: var(--red-dim);
  border: 1px solid rgba(239,68,68,0.25);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--red);
  font-weight: 600;
}

.sidebar-footer { padding: 0 14px; display: flex; flex-direction: column; gap: 8px; }

.main {
  flex: 1;
  padding: 28px 36px;
  overflow-y: auto;
  height: 100vh;
}

/* â•â•â• TYPOGRAPHY â•â•â• */
.page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; }
.page-title { font-size: 28px; font-weight: 900; color: var(--text-primary); letter-spacing: -0.03em; }
.page-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; font-weight: 400; }
.section-title { font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; }

/* â•â•â• BUTTONS â•â•â• */
.btn-primary {
  padding: 10px 20px;
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }

.btn-secondary {
  padding: 10px 20px;
  background: var(--bg-raised);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}
.btn-secondary:hover { background: var(--bg-hover); }

.btn-action {
  padding: 7px 14px;
  background: var(--bg-surface);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-action:hover { background: var(--bg-hover); color: var(--text-primary); }

.btn-small {
  padding: 4px 9px;
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
}
.btn-small:hover { color: var(--text-secondary); background: var(--bg-hover); }
.btn-small.danger:hover { color: var(--red); border-color: rgba(239,68,68,0.3); }

.btn-link {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 12px;
  cursor: pointer;
  text-decoration: underline;
  font-family: var(--font);
}
.btn-link:hover { color: var(--text-secondary); }

/* â•â•â• FORMS â•â•â• */
.input {
  width: 100%;
  padding: 9px 12px;
  background: var(--bg-base);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  transition: border-color 0.15s;
}
.input:focus { border-color: var(--accent-border); }
.input::placeholder { color: var(--text-muted); }
select.input { cursor: pointer; }
textarea.input { resize: vertical; min-height: 70px; line-height: 1.6; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px 16px; }
.form-group { }
.form-group.full { grid-column: 1 / -1; }
.form-label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  margin-bottom: 5px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

/* â•â•â• BADGE â•â•â• */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.02em;
}

/* â•â•â• STAGE BAR â•â•â• */
.stage-bar { display: flex; align-items: center; gap: 3px; }
.stage-dot { width: 8px; height: 8px; border-radius: 2px; background: var(--bg-hover); transition: background 0.2s; }
.stage-label { font-size: 11px; font-weight: 700; margin-left: 6px; }

/* â•â•â• QUEUE â•â•â• */
.queue-list { display: flex; flex-direction: column; gap: 10px; }

.queue-card {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  padding: 18px 22px;
  border-left: 3px solid var(--text-muted);
  transition: all 0.15s;
}
.queue-card:hover { background: var(--bg-raised); }

.queue-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
.queue-card-name { font-size: 16px; font-weight: 700; color: var(--text-primary); }
.queue-card-company { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
.queue-card-meta { display: flex; align-items: center; gap: 12px; }

.queue-action {
  font-size: 13px;
  color: var(--accent);
  font-weight: 500;
  padding: 8px 12px;
  background: var(--accent-dim);
  border-radius: var(--radius-sm);
  margin: 8px 0;
}

.queue-notes { font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 6px; }

.queue-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.queue-actions .btn-action.ml-auto { margin-left: auto; opacity: 0.6; }

/* â•â•â• TABLE â•â•â• */
.filter-bar { display: flex; gap: 12px; margin-bottom: 20px; }
.filter-bar .input { max-width: 280px; }
.filter-bar select.input { max-width: 180px; }

.table-wrap { background: var(--bg-surface); border-radius: var(--radius-lg); overflow: hidden; }
table { width: 100%; border-collapse: collapse; }
th {
  text-align: left;
  padding: 12px 16px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border);
}
tr { border-bottom: 1px solid var(--bg-base); transition: background 0.1s; }
tr:hover { background: var(--bg-raised); }
tr:last-child { border-bottom: none; }
td { padding: 12px 16px; font-size: 14px; }
.td-contact-name { font-weight: 600; color: var(--text-primary); }
.td-contact-role { font-size: 12px; color: var(--text-muted); }
.td-actions { display: flex; gap: 6px; }

/* â•â•â• PIPELINE â•â•â• */
.pipeline-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  min-height: 420px;
}
.pipeline-col { background: var(--bg-surface); border-radius: var(--radius); overflow: hidden; }
.pipeline-col-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 12px;
  border-bottom: 1px solid var(--border);
}
.pipeline-col-dot { width: 8px; height: 8px; border-radius: 50%; }
.pipeline-col-title { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.04em; }
.pipeline-col-count { margin-left: auto; font-size: 11px; font-weight: 700; color: var(--text-muted); }
.pipeline-col-body { padding: 8px; display: flex; flex-direction: column; gap: 6px; min-height: 100px; }

.pipeline-card {
  padding: 10px 12px;
  background: var(--bg-base);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s;
  border: 1px solid transparent;
}
.pipeline-card:hover { border-color: var(--border-light); background: var(--bg-raised); }
.pipeline-card-name { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px; }
.pipeline-card-company { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
.pipeline-card-footer { display: flex; justify-content: space-between; align-items: center; }
.pipeline-card-date { font-size: 11px; color: var(--text-muted); }

.pipeline-summary { display: flex; gap: 14px; margin-top: 18px; }

/* â•â•â• TEMPLATES â•â•â• */
.template-grid { display: flex; flex-direction: column; gap: 14px; }
.template-card { background: var(--bg-surface); border-radius: var(--radius-lg); padding: 18px 22px; }
.template-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.template-card-name { font-size: 15px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
.template-preview {
  font-size: 12px;
  line-height: 1.6;
  color: var(--text-muted);
  background: var(--bg-base);
  padding: 14px;
  border-radius: 8px;
  white-space: pre-wrap;
  font-family: var(--mono);
  max-height: 160px;
  overflow: auto;
}

.var-btn {
  padding: 3px 8px;
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid var(--accent-border);
  border-radius: 4px;
  font-size: 11px;
  font-family: var(--mono);
  cursor: pointer;
}
.var-btn:hover { filter: brightness(1.2); }
.var-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }

/* â•â•â• STATS â•â•â• */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
.stat-card {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  padding: 20px 22px;
  border: 1px solid var(--border);
}
.stat-value { font-size: 34px; font-weight: 900; color: var(--text-primary); letter-spacing: -0.03em; }
.stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; margin-top: 2px; }

.funnel-wrap { display: flex; flex-direction: column; gap: 8px; }
.funnel-row { display: flex; align-items: center; gap: 12px; }
.funnel-label { width: 110px; font-size: 13px; color: var(--text-muted); font-weight: 500; text-align: right; flex-shrink: 0; }
.funnel-bar-bg { flex: 1; height: 26px; background: var(--bg-base); border-radius: 4px; overflow: hidden; }
.funnel-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; min-width: 2px; }
.funnel-count { width: 32px; font-size: 14px; font-weight: 700; color: var(--text-primary); }

.channel-row { display: flex; gap: 14px; }
.channel-card { flex: 1; }
.channel-label { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; }
.channel-stats { display: flex; justify-content: space-between; }
.channel-big { font-size: 30px; font-weight: 900; color: var(--text-primary); }
.channel-small { font-size: 12px; color: var(--text-muted); }
.channel-accent { color: var(--accent); }

.analytics-note {
  margin-top: 30px;
  padding: 20px 24px;
  background: var(--bg-base);
  border-radius: var(--radius);
  border: 1px dashed var(--border-light);
  color: var(--text-muted);
  font-size: 14px;
  line-height: 1.6;
}

/* â•â•â• DISCOVER â•â•â• */
.discover-search-area {
  margin-bottom: 24px;
}
.discover-prompt-row {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  margin-bottom: 12px;
}
.discover-input {
  flex: 1;
  min-height: 80px;
  resize: vertical;
  line-height: 1.6;
}
.discover-btn {
  height: 80px;
  padding: 0 28px;
  white-space: nowrap;
  flex-shrink: 0;
}
.discover-presets {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.discover-preset {
  padding: 4px 10px;
  background: var(--bg-surface);
  color: var(--text-muted);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  font-family: var(--font);
  transition: all 0.15s;
}
.discover-preset:hover {
  background: var(--bg-hover);
  color: var(--text-secondary);
  border-color: var(--border-light);
}

.discover-results-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.discover-card {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  padding: 20px 24px;
  border: 1px solid var(--border);
  transition: all 0.15s;
}
.discover-card:hover {
  border-color: var(--border-light);
  background: var(--bg-raised);
}
.discover-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}
.discover-card-company {
  font-size: 18px;
  font-weight: 800;
  color: var(--text-primary);
  letter-spacing: -0.02em;
}
.discover-card-contact {
  font-size: 14px;
  color: var(--text-secondary);
  font-weight: 500;
  margin-top: 2px;
}
.discover-card-signal {
  margin: 10px 0;
  padding: 8px 12px;
  background: var(--accent-dim);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent);
}
.discover-card-signal-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 3px;
}
.discover-card-signal-text {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}
.discover-card-context {
  font-size: 13px;
  color: var(--text-muted);
  line-height: 1.6;
  margin-bottom: 12px;
}
.discover-card-tags {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.discover-card-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.discover-status-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 18px;
  background: var(--bg-surface);
  border-radius: var(--radius);
  margin-bottom: 20px;
  font-size: 13px;
}

/* â•â•â• MODAL â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: fadeIn 0.15s ease;
}
.modal {
  background: var(--bg-raised);
  border-radius: 16px;
  padding: 26px 30px;
  max-width: 580px;
  width: 100%;
  max-height: 90vh;
  overflow: auto;
  border: 1px solid var(--border-light);
  animation: slideUp 0.2s ease;
}
.modal.wide { max-width: 720px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
.modal-title { font-size: 19px; font-weight: 800; color: var(--text-primary); }
.modal-close {
  background: transparent;
  border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
  line-height: 1;
}
.modal-close:hover { color: var(--text-secondary); }

.compose-to {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 18px;
  padding: 12px 16px;
  background: var(--bg-base);
  border-radius: var(--radius);
}
.compose-to-label { font-size: 14px; color: var(--text-muted); }
.compose-to-name { font-weight: 600; color: var(--text-primary); }
.compose-to-company { margin-left: auto; font-size: 13px; color: var(--text-muted); }
.compose-hint { font-size: 12px; color: var(--text-muted); margin-bottom: 16px; }

/* â•â•â• AI DRAFTING â•â•â• */
.ai-section {
  margin-bottom: 16px;
  padding: 14px 16px;
  background: var(--bg-base);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.ai-section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  font-size: 12px;
  font-weight: 700;
  color: var(--purple);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.ai-context-input {
  width: 100%;
  padding: 9px 12px;
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font);
  outline: none;
  resize: vertical;
  min-height: 60px;
  line-height: 1.6;
  margin-bottom: 10px;
}
.ai-context-input:focus { border-color: var(--purple); }
.ai-context-input::placeholder { color: var(--text-muted); }

.btn-ai {
  padding: 9px 18px;
  background: linear-gradient(135deg, #7C3AED, #A78BFA);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font);
}
.btn-ai:hover { filter: brightness(1.15); transform: translateY(-1px); }
.btn-ai:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }

.btn-email {
  padding: 9px 18px;
  background: var(--blue);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  text-decoration: none;
  display: inline-block;
  font-family: var(--font);
}
.btn-email:hover { filter: brightness(1.15); transform: translateY(-1px); }

.ai-status {
  font-size: 12px;
  color: var(--purple);
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.ai-spinner {
  width: 12px; height: 12px;
  border: 2px solid var(--border);
  border-top-color: var(--purple);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â• SETTINGS â•â•â• */
.settings-section {
  padding: 12px 14px;
  margin: 0 14px 8px;
  background: var(--bg-surface);
  border-radius: 8px;
  border: 1px solid var(--border);
}
.settings-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 6px;
}
.settings-input {
  width: 100%;
  padding: 6px 8px;
  background: var(--bg-base);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 11px;
  font-family: var(--mono);
  outline: none;
}
.settings-input:focus { border-color: var(--purple); }
.settings-status {
  font-size: 10px;
  margin-top: 4px;
  color: var(--green);
  font-weight: 600;
}

/* â•â•â• EMPTY STATE â•â•â• */
.empty-state {
  text-align: center;
  padding: 60px 40px;
  background: var(--bg-surface);
  border-radius: 16px;
}
.empty-icon { font-size: 44px; color: var(--accent); margin-bottom: 16px; }
.empty-title { font-size: 21px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; }
.empty-text { font-size: 14px; color: var(--text-muted); line-height: 1.6; max-width: 480px; margin: 0 auto 22px; }

.table-empty { text-align: center; color: var(--text-muted); padding: 40px; font-size: 14px; }

/* â•â•â• ANIMATIONS â•â•â• */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* â•â•â• VIEW TRANSITIONS â•â•â• */
.view { display: none; animation: fadeIn 0.2s ease; }
.view.active { display: block; }

/* â•â•â• DATA MANAGEMENT ROW â•â•â• */
.data-row { display: flex; gap: 8px; }
.data-row .btn-link { font-size: 11px; }
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo">
      <span class="logo-icon">â—†</span>
      <span class="logo-text">Pipeline</span>
    </div>
    <nav class="nav" id="nav"></nav>
    <div id="overdue-alert"></div>
    <div class="sidebar-footer">
      <div class="settings-section">
        <div class="settings-label">âœ¦ Claude AI Key</div>
        <input type="password" class="settings-input" id="api-key-input" placeholder="sk-ant-..." oninput="saveApiKey(this.value)" />
        <div class="settings-status" id="api-key-status"></div>
      </div>
      <button class="btn-primary" onclick="openAddProspect()" style="width:100%">+ Add Prospect</button>
      <div class="data-row">
        <button class="btn-link" onclick="exportData()">Export backup</button>
        <button class="btn-link" onclick="document.getElementById('import-file').click()">Import</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- QUEUE VIEW -->
    <div class="view active" id="view-queue">
      <div class="page-header">
        <div>
          <h1 class="page-title">Today's Queue</h1>
          <p class="page-subtitle" id="queue-subtitle"></p>
        </div>
        <button class="btn-primary" onclick="openAddProspect()">+ Add Prospect</button>
      </div>
      <div id="queue-list"></div>
    </div>

    <!-- PROSPECTS VIEW -->
    <div class="view" id="view-prospects">
      <div class="page-header">
        <div>
          <h1 class="page-title">All Prospects</h1>
          <p class="page-subtitle" id="prospects-subtitle"></p>
        </div>
        <button class="btn-primary" onclick="openAddProspect()">+ Add Prospect</button>
      </div>
      <div class="filter-bar">
        <input class="input" id="search-input" placeholder="Search by name or company..." oninput="renderProspects()">
        <select class="input" id="filter-stage" onchange="renderProspects()">
          <option value="all">All Stages</option>
        </select>
      </div>
      <div id="prospects-table"></div>
    </div>

    <!-- PIPELINE VIEW -->
    <div class="view" id="view-pipeline">
      <div class="page-header">
        <h1 class="page-title">Pipeline</h1>
      </div>
      <div id="pipeline-grid"></div>
      <div id="pipeline-summary"></div>
    </div>

    <!-- TEMPLATES VIEW -->
    <div class="view" id="view-templates">
      <div class="page-header">
        <div>
          <h1 class="page-title">Message Templates</h1>
          <p class="page-subtitle">Pre-built templates with personalization slots</p>
        </div>
        <button class="btn-primary" onclick="openAddTemplate()">+ New Template</button>
      </div>
      <div id="templates-list"></div>
    </div>

    <!-- DISCOVER VIEW -->
    <div class="view" id="view-discover">
      <div class="page-header">
        <div>
          <h1 class="page-title">Discover Prospects</h1>
          <p class="page-subtitle">AI-powered prospect finding â€” describe what you're looking for</p>
        </div>
      </div>

      <div class="discover-search-area">
        <div class="discover-prompt-row">
          <textarea class="input discover-input" id="discover-query" placeholder="Describe what you're looking for, e.g.:\n\nâ€¢ DTC e-commerce brands that recently redesigned their site\nâ€¢ Mission-driven consumer brands, 50-200 employees, US-based\nâ€¢ Companies like Peak Design and Bombas\nâ€¢ E-commerce companies hiring UX researchers (signal they need one)\nâ€¢ Shopify brands that just raised a Series A or B"></textarea>
          <button class="btn-ai discover-btn" id="discover-btn" onclick="runDiscover()">âœ¦ Find Prospects</button>
        </div>
        <div class="discover-presets">
          <span style="font-size:11px;color:var(--text-muted);font-weight:600">Quick searches:</span>
          <button class="discover-preset" onclick="setDiscoverQuery('DTC e-commerce brands that recently redesigned or migrated their website in 2025-2026')">Recent redesigns</button>
          <button class="discover-preset" onclick="setDiscoverQuery('Mission-driven e-commerce companies similar to Peak Design, Bombas, Allbirds â€” mid-market, strong values, DTC-first')">Mission-driven DTC</button>
          <button class="discover-preset" onclick="setDiscoverQuery('E-commerce companies currently hiring UX researchers or product designers â€” they have the need but haven\\'t filled it yet')">Hiring UX roles</button>
          <button class="discover-preset" onclick="setDiscoverQuery('Shopify or DTC brands that raised Series A or B funding in 2025 and are scaling their product/growth team')">Recently funded</button>
          <button class="discover-preset" onclick="setDiscoverQuery('E-commerce brands with conversion or retention problems â€” look for public discussions, case studies, or job postings mentioning these challenges')">Conversion challenges</button>
        </div>
      </div>

      <div id="discover-status" style="display:none"></div>
      <div id="discover-results"></div>
    </div>

    <!-- ANALYTICS VIEW -->
    <div class="view" id="view-analytics">
      <div class="page-header">
        <h1 class="page-title">Analytics</h1>
      </div>
      <div id="analytics-content"></div>
    </div>
  </div>
</div>

<!-- MODAL CONTAINER -->
<div id="modal-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STAGES = [
  { id: "researched", label: "Researched", color: "#6B7280" },
  { id: "first_touch", label: "First Touch", color: "#4B8BF5" },
  { id: "follow_up_1", label: "Follow-up 1", color: "#A78BFA" },
  { id: "follow_up_2", label: "Follow-up 2", color: "#EC4899" },
  { id: "meeting_booked", label: "Meeting Booked", color: "#E8A427" },
  { id: "proposal_sent", label: "Proposal Sent", color: "#22C55E" },
  { id: "won", label: "Won", color: "#059669" },
  { id: "lost", label: "Lost", color: "#EF4444" },
];

const ACTIVE_STAGES = STAGES.filter(s => !["won","lost"].includes(s.id));
const WARMTH = { cold: "â„ï¸", warm: "ğŸ”¥", hot: "âš¡" };
const CHANNELS = [{ id: "linkedin", label: "LinkedIn DM" }, { id: "email", label: "Cold Email" }];
const SOURCES = ["LinkedIn", "Referral", "Inbound", "Twitter/X", "Conference", "Other"];
const FOLLOW_UP_DAYS = { first_touch: 3, follow_up_1: 5, follow_up_2: 7 };

const DEFAULT_TEMPLATES = [
  {
    id: "t1", name: "LinkedIn â€” Cold Intro", channel: "linkedin", subject: "",
    body: `Hi {{first_name}},\n\nI led behavioral research at TikTok Shop (30M+ users) where I discovered that {{pain_point_insight}}.\n\nI noticed {{company}} is {{company_observation}}. I now help e-commerce companies diagnose exactly why users browse but don't buy â€” and quantify the revenue impact of fixing it.\n\nWould you be open to a 15-minute conversation about {{specific_topic}}?`
  },
  {
    id: "t2", name: "Email â€” Cold Intro", channel: "email",
    subject: "Quick question about {{company}}'s conversion",
    body: `Hi {{first_name}},\n\nI came across {{company}} and noticed {{company_observation}}.\n\nI recently led platform-scale research at TikTok Shop where I proved that fixing trust and quality barriers had higher ROI than loyalty programs â€” redirecting a multi-million dollar roadmap in the process.\n\nI now work with mid-market e-commerce companies to diagnose *why* users don't convert and quantify the revenue impact of each barrier.\n\nWould it make sense to chat for 15 minutes about how this might apply to {{company}}?\n\nBest,\nMouslim`
  },
  {
    id: "t3", name: "LinkedIn â€” Follow-up", channel: "linkedin", subject: "",
    body: `Hi {{first_name}}, just circling back on my note. I recently published a case study on {{relevant_case_study}} that might be relevant to what you're working on at {{company}}. Happy to share if useful.`
  },
  {
    id: "t4", name: "Email â€” Follow-up", channel: "email",
    subject: "Re: Quick question about {{company}}'s conversion",
    body: `Hi {{first_name}},\n\nFollowing up on my previous note. I wanted to share a quick insight that might be relevant:\n\n{{pain_point_insight}}\n\nIf this resonates with what you're seeing at {{company}}, I'd love to chat. If not, no worries at all.\n\nBest,\nMouslim`
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function loadProspects() {
  try { return JSON.parse(localStorage.getItem("pipeline_prospects")) || []; } catch { return []; }
}
function saveProspects(data) { localStorage.setItem("pipeline_prospects", JSON.stringify(data)); }
function loadTemplates() {
  try {
    const d = JSON.parse(localStorage.getItem("pipeline_templates"));
    return d && d.length ? d : DEFAULT_TEMPLATES;
  } catch { return DEFAULT_TEMPLATES; }
}
function saveTemplates(data) { localStorage.setItem("pipeline_templates", JSON.stringify(data)); }

let prospects = loadProspects();
let templates = loadTemplates();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }
function todayStr() { return new Date().toISOString().split("T")[0]; }
function daysAgo(d) { if(!d) return Infinity; return Math.floor((new Date()-new Date(d))/(864e5)); }
function fmtDate(d) { if(!d) return "â€”"; return new Date(d+"T12:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}); }
function futureDate(days) { return new Date(Date.now()+days*864e5).toISOString().split("T")[0]; }

function stageInfo(id) { return STAGES.find(s=>s.id===id) || STAGES[0]; }
function stageIdx(id) { return STAGES.findIndex(s=>s.id===id); }

function escHtml(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

function badge(color, text) {
  return `<span class="badge" style="background:${color}18;color:${color};border:1px solid ${color}40">${escHtml(text)}</span>`;
}

function stageBar(stage) {
  const idx = stageIdx(stage);
  const s = stageInfo(stage);
  let dots = ACTIVE_STAGES.map((st,i) =>
    `<div class="stage-dot" style="background:${i<=idx?s.color:'var(--bg-hover)'}"></div>`
  ).join("");
  return `<div class="stage-bar">${dots}<span class="stage-label" style="color:${s.color}">${s.label}</span></div>`;
}

function channelBadge(ch) {
  return ch === "linkedin" ? badge("#0A66C2","LinkedIn") : badge("#4B8BF5","Email");
}
function channelBadgeShort(ch) {
  return ch === "linkedin" ? badge("#0A66C2","LI") : badge("#4B8BF5","âœ‰");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentView = "queue";
const NAV_ITEMS = [
  { id: "queue", label: "Today's Queue", icon: "âš¡" },
  { id: "discover", label: "Discover", icon: "âœ¦" },
  { id: "prospects", label: "Prospects", icon: "â—" },
  { id: "pipeline", label: "Pipeline", icon: "â–§" },
  { id: "templates", label: "Templates", icon: "âœ" },
  { id: "analytics", label: "Analytics", icon: "â—ˆ" },
];

function renderNav() {
  const queue = getQueue();
  const nav = document.getElementById("nav");
  nav.innerHTML = NAV_ITEMS.map(item => {
    let count = "";
    if (item.id === "queue" && queue.length > 0) count = `<span class="nav-count alert">${queue.length}</span>`;
    else if (item.id === "prospects") count = `<span class="nav-count">${prospects.length}</span>`;
    else if (item.id === "templates") count = `<span class="nav-count">${templates.length}</span>`;
    return `<button class="nav-item ${currentView===item.id?'active':''}" onclick="switchView('${item.id}')">
      <span class="nav-icon">${item.icon}</span><span>${item.label}</span>${count}
    </button>`;
  }).join("");

  // Overdue alert
  const overdue = prospects.filter(p => p.nextActionDate && p.nextActionDate < todayStr() && !["won","lost"].includes(p.stage)).length;
  document.getElementById("overdue-alert").innerHTML = overdue > 0
    ? `<div class="overdue-alert"><span>âš </span><span>${overdue} overdue action${overdue>1?'s':''}</span></div>` : "";
}

function switchView(id) {
  currentView = id;
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById("view-"+id).classList.add("active");
  renderNav();
  if (id === "queue") renderQueue();
  else if (id === "discover") {} // static view, no render needed
  else if (id === "prospects") renderProspects();
  else if (id === "pipeline") renderPipeline();
  else if (id === "templates") renderTemplates();
  else if (id === "analytics") renderAnalytics();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getQueue() {
  const today = todayStr();
  return prospects.filter(p => {
    if (p.stage === "won" || p.stage === "lost") return false;
    if (!p.nextActionDate) return p.stage === "researched";
    return p.nextActionDate <= today;
  }).sort((a,b) => {
    const w = {hot:0,warm:1,cold:2};
    return (w[a.warmth]||2) - (w[b.warmth]||2);
  });
}

function renderQueue() {
  const queue = getQueue();
  const sub = document.getElementById("queue-subtitle");
  sub.textContent = queue.length === 0
    ? "Nothing due today â€” add more prospects or enjoy the surf ğŸ„"
    : `${queue.length} action${queue.length>1?'s':''} due today`;

  const container = document.getElementById("queue-list");
  if (queue.length === 0 && prospects.length === 0) {
    container.innerHTML = `<div class="empty-state">
      <div class="empty-icon">â—†</div>
      <h3 class="empty-title">Start building your pipeline</h3>
      <p class="empty-text">Add your first 5 prospects to kick off outreach. Target VP Product / VP Growth at e-commerce companies doing $10Mâ€“$100M.</p>
      <button class="btn-primary" onclick="openAddProspect()">+ Add Your First Prospect</button>
    </div>`;
    return;
  }
  if (queue.length === 0) {
    container.innerHTML = `<div class="empty-state">
      <div class="empty-icon">âœ“</div>
      <h3 class="empty-title">All caught up</h3>
      <p class="empty-text">No actions due today. You have ${prospects.length} prospect${prospects.length>1?'s':''} in your pipeline.</p>
    </div>`;
    return;
  }

  container.innerHTML = `<div class="queue-list">${queue.map(p => {
    const si = stageInfo(p.stage);
    const isOverdue = p.nextActionDate && p.nextActionDate < todayStr();
    return `<div class="queue-card" style="border-left-color:${si.color}">
      <div class="queue-card-top">
        <div>
          <div style="display:flex;align-items:center;gap:10px">
            <span class="queue-card-name">${escHtml(p.contact)}</span>
            <span style="font-size:14px">${WARMTH[p.warmth]||""}</span>
            ${isOverdue ? badge("#EF4444","Overdue "+daysAgo(p.nextActionDate)+"d") : ""}
          </div>
          <div class="queue-card-company">${p.role?escHtml(p.role)+" Â· ":""}${escHtml(p.company)}</div>
        </div>
        <div class="queue-card-meta">${stageBar(p.stage)}${channelBadge(p.channel)}</div>
      </div>
      ${p.nextAction ? `<div class="queue-action"><strong>Action:</strong> ${escHtml(p.nextAction)}</div>` : ""}
      ${p.notes ? `<div class="queue-notes">${escHtml(p.notes)}</div>` : ""}
      <div class="queue-actions">
        <button class="btn-action" onclick="openCompose('${p.id}')">âœ‰ Compose Message</button>
        <button class="btn-action" onclick="advanceStage('${p.id}')">â†’ Advance Stage</button>
        <button class="btn-action ml-auto" onclick="openEditProspect('${p.id}')">Edit</button>
      </div>
    </div>`;
  }).join("")}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROSPECTS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderProspects() {
  document.getElementById("prospects-subtitle").textContent = `${prospects.length} total prospects`;

  // Fill stage filter if needed
  const filterSelect = document.getElementById("filter-stage");
  if (filterSelect.options.length <= 1) {
    STAGES.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.label;
      filterSelect.appendChild(opt);
    });
  }

  const search = document.getElementById("search-input").value.toLowerCase();
  const stageFilter = document.getElementById("filter-stage").value;

  const filtered = prospects.filter(p => {
    const matchSearch = !search || p.company.toLowerCase().includes(search) || p.contact.toLowerCase().includes(search);
    const matchStage = stageFilter === "all" || p.stage === stageFilter;
    return matchSearch && matchStage;
  });

  const container = document.getElementById("prospects-table");
  if (filtered.length === 0) {
    container.innerHTML = `<div class="table-wrap"><div class="table-empty">No prospects match your filters.</div></div>`;
    return;
  }

  container.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Contact / Company</th><th>Channel</th><th>Stage</th><th>Next Action</th><th>Due</th><th></th>
    </tr></thead>
    <tbody>${filtered.map(p => {
      const isOverdue = p.nextActionDate && p.nextActionDate < todayStr() && !["won","lost"].includes(p.stage);
      return `<tr>
        <td><div style="display:flex;align-items:center;gap:8px">
          <span>${WARMTH[p.warmth]||""}</span>
          <div><div class="td-contact-name">${escHtml(p.contact)}</div>
          <div class="td-contact-role">${p.role?escHtml(p.role)+" Â· ":""}${escHtml(p.company)}</div></div>
        </div></td>
        <td>${channelBadgeShort(p.channel)}</td>
        <td>${stageBar(p.stage)}</td>
        <td style="font-size:13px;color:var(--text-secondary);max-width:200px">${escHtml(p.nextAction||"â€”")}</td>
        <td style="${isOverdue?'color:var(--red);font-weight:600':'color:var(--text-muted)'}">${p.nextActionDate?fmtDate(p.nextActionDate):"â€”"}</td>
        <td><div class="td-actions">
          <button class="btn-small" onclick="openCompose('${p.id}')" title="Compose">âœ‰</button>
          <button class="btn-small" onclick="openEditProspect('${p.id}')" title="Edit">âœ</button>
          <button class="btn-small danger" onclick="deleteProspect('${p.id}')" title="Delete">âœ•</button>
        </div></td>
      </tr>`;
    }).join("")}</tbody>
  </table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPipeline() {
  const grid = document.getElementById("pipeline-grid");
  grid.innerHTML = `<div class="pipeline-grid">${ACTIVE_STAGES.map(stage => {
    const sp = prospects.filter(p => p.stage === stage.id);
    return `<div class="pipeline-col">
      <div class="pipeline-col-header">
        <div class="pipeline-col-dot" style="background:${stage.color}"></div>
        <span class="pipeline-col-title">${stage.label}</span>
        <span class="pipeline-col-count">${sp.length}</span>
      </div>
      <div class="pipeline-col-body">
        ${sp.length === 0 ? '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:16px 0">Empty</p>' :
          sp.map(p => `<div class="pipeline-card" onclick="openEditProspect('${p.id}')">
            <div class="pipeline-card-name">${escHtml(p.contact)}</div>
            <div class="pipeline-card-company">${escHtml(p.company)}</div>
            <div class="pipeline-card-footer">${channelBadge(p.channel)}<span class="pipeline-card-date">${fmtDate(p.stageDate)}</span></div>
          </div>`).join("")}
      </div>
    </div>`;
  }).join("")}</div>`;

  const won = prospects.filter(p=>p.stage==="won").length;
  const lost = prospects.filter(p=>p.stage==="lost").length;
  document.getElementById("pipeline-summary").innerHTML = `<div class="pipeline-summary">
    <div class="stat-card" style="flex:1;border-color:#059669"><div class="stat-value" style="color:#22C55E">${won}</div><div class="stat-label">Won</div></div>
    <div class="stat-card" style="flex:1;border-color:#EF4444"><div class="stat-value" style="color:#EF4444">${lost}</div><div class="stat-label">Lost</div></div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTemplates() {
  const container = document.getElementById("templates-list");
  container.innerHTML = `<div class="template-grid">${templates.map(t => `
    <div class="template-card">
      <div class="template-card-header">
        <div>
          <div class="template-card-name">${escHtml(t.name)}</div>
          ${channelBadge(t.channel)}
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn-small" onclick="openEditTemplate('${t.id}')">âœ</button>
          <button class="btn-small danger" onclick="deleteTemplate('${t.id}')">âœ•</button>
        </div>
      </div>
      ${t.subject ? `<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Subject: ${escHtml(t.subject)}</div>` : ""}
      <pre class="template-preview">${escHtml(t.body)}</pre>
    </div>
  `).join("")}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAnalytics() {
  const total = prospects.length;
  const active = prospects.filter(p=>!["won","lost"].includes(p.stage)).length;
  const won = prospects.filter(p=>p.stage==="won").length;
  const lost = prospects.filter(p=>p.stage==="lost").length;
  const meetings = prospects.filter(p=>["meeting_booked","proposal_sent","won"].includes(p.stage)).length;
  const convRate = total > 0 ? ((won/total)*100).toFixed(0) : 0;
  const meetingRate = total > 0 ? ((meetings/total)*100).toFixed(0) : 0;

  const byStage = {};
  STAGES.forEach(s => { byStage[s.id] = prospects.filter(p=>p.stage===s.id).length; });
  const maxCount = Math.max(...Object.values(byStage), 1);

  const byChannel = {linkedin:0,email:0}, byChMeetings = {linkedin:0,email:0};
  prospects.forEach(p => {
    if(byChannel[p.channel]!==undefined) byChannel[p.channel]++;
    if(["meeting_booked","proposal_sent","won"].includes(p.stage) && byChMeetings[p.channel]!==undefined) byChMeetings[p.channel]++;
  });

  const container = document.getElementById("analytics-content");
  container.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">Total Prospects</div></div>
      <div class="stat-card"><div class="stat-value">${active}</div><div class="stat-label">Active</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--accent)">${meetingRate}%</div><div class="stat-label">Meeting Rate</div></div>
      <div class="stat-card"><div class="stat-value" style="color:#22C55E">${convRate}%</div><div class="stat-label">Win Rate</div></div>
    </div>

    <h2 class="section-title" style="margin-top:32px">Pipeline Breakdown</h2>
    <div class="funnel-wrap">
      ${STAGES.map(s => {
        const count = byStage[s.id]||0;
        const pct = (count/maxCount)*100;
        return `<div class="funnel-row">
          <div class="funnel-label">${s.label}</div>
          <div class="funnel-bar-bg"><div class="funnel-bar-fill" style="width:${Math.max(pct,2)}%;background:${s.color}"></div></div>
          <div class="funnel-count">${count}</div>
        </div>`;
      }).join("")}
    </div>

    <h2 class="section-title" style="margin-top:32px">Channel Performance</h2>
    <div class="channel-row">
      ${CHANNELS.map(ch => {
        const t = byChannel[ch.id]||0;
        const m = byChMeetings[ch.id]||0;
        const rate = t>0 ? ((m/t)*100).toFixed(0) : 0;
        return `<div class="stat-card channel-card">
          <div class="channel-label">${ch.label}</div>
          <div class="channel-stats">
            <div><div class="channel-big">${t}</div><div class="channel-small">prospects</div></div>
            <div style="text-align:right"><div class="channel-big channel-accent">${rate}%</div><div class="channel-small">to meeting</div></div>
          </div>
        </div>`;
      }).join("")}
    </div>

    ${total < 15 ? `<div class="analytics-note">Analytics become meaningful after ~20 prospects. Keep adding and working your queue â€” the patterns will emerge.</div>` : ""}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openModal(title, content, wide) {
  document.getElementById("modal-container").innerHTML = `
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal ${wide?'wide':''}" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">${title}</h2>
          <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div id="modal-body">${content}</div>
      </div>
    </div>`;
}
function closeModal() { document.getElementById("modal-container").innerHTML = ""; }

function prospectFormHtml(p) {
  const isEdit = !!p;
  p = p || { company:"",contact:"",role:"",email:"",linkedin:"",revenue:"",employees:"",
    industry:"E-commerce",warmth:"cold",source:"LinkedIn",channel:"linkedin",notes:"",
    stage:"researched",nextAction:"",nextActionDate:todayStr() };
  return `<div class="form-grid">
    <div class="form-group"><label class="form-label">Company *</label><input class="input" id="f-company" value="${escHtml(p.company)}" placeholder="Acme Inc."></div>
    <div class="form-group"><label class="form-label">Contact Name *</label><input class="input" id="f-contact" value="${escHtml(p.contact)}" placeholder="Jane Smith"></div>
    <div class="form-group"><label class="form-label">Role</label><input class="input" id="f-role" value="${escHtml(p.role||"")}" placeholder="VP Product"></div>
    <div class="form-group"><label class="form-label">Email</label><input class="input" id="f-email" type="email" value="${escHtml(p.email||"")}" placeholder="jane@acme.com"></div>
    <div class="form-group"><label class="form-label">LinkedIn URL</label><input class="input" id="f-linkedin" value="${escHtml(p.linkedin||"")}" placeholder="linkedin.com/in/janesmith"></div>
    <div class="form-group"><label class="form-label">Industry</label><input class="input" id="f-industry" value="${escHtml(p.industry||"E-commerce")}" placeholder="E-commerce"></div>
    <div class="form-group"><label class="form-label">Est. Revenue</label><input class="input" id="f-revenue" value="${escHtml(p.revenue||"")}" placeholder="$10Mâ€“$50M"></div>
    <div class="form-group"><label class="form-label">Employees</label><input class="input" id="f-employees" value="${escHtml(p.employees||"")}" placeholder="50â€“200"></div>
    <div class="form-group"><label class="form-label">Channel</label><select class="input" id="f-channel">
      ${CHANNELS.map(c=>`<option value="${c.id}" ${p.channel===c.id?'selected':''}>${c.label}</option>`).join("")}
    </select></div>
    <div class="form-group"><label class="form-label">Warmth</label><select class="input" id="f-warmth">
      <option value="cold" ${p.warmth==="cold"?'selected':''}>â„ï¸ Cold</option>
      <option value="warm" ${p.warmth==="warm"?'selected':''}>ğŸ”¥ Warm</option>
      <option value="hot" ${p.warmth==="hot"?'selected':''}>âš¡ Hot</option>
    </select></div>
    <div class="form-group"><label class="form-label">Source</label><select class="input" id="f-source">
      ${SOURCES.map(s=>`<option value="${s}" ${p.source===s?'selected':''}>${s}</option>`).join("")}
    </select></div>
    <div class="form-group"><label class="form-label">Stage</label><select class="input" id="f-stage">
      ${STAGES.map(s=>`<option value="${s.id}" ${p.stage===s.id?'selected':''}>${s.label}</option>`).join("")}
    </select></div>
    <div class="form-group full"><label class="form-label">Next Action</label>
      <div style="display:flex;gap:10px">
        <input class="input" id="f-nextAction" value="${escHtml(p.nextAction||"")}" placeholder="Send intro DM" style="flex:1">
        <input class="input" id="f-nextActionDate" type="date" value="${p.nextActionDate||todayStr()}" style="width:160px">
      </div>
    </div>
    <div class="form-group full"><label class="form-label">Notes</label>
      <textarea class="input" id="f-notes" placeholder="Key observations, pain points, company context...">${escHtml(p.notes||"")}</textarea>
    </div>
    <div class="form-group full" style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" onclick="${isEdit?`saveEditProspect('${p.id}')`:'saveNewProspect()'}">${isEdit?'Save Changes':'Add Prospect'}</button>
    </div>
  </div>`;
}

function getFormData() {
  return {
    company: document.getElementById("f-company").value.trim(),
    contact: document.getElementById("f-contact").value.trim(),
    role: document.getElementById("f-role").value.trim(),
    email: document.getElementById("f-email").value.trim(),
    linkedin: document.getElementById("f-linkedin").value.trim(),
    industry: document.getElementById("f-industry").value.trim(),
    revenue: document.getElementById("f-revenue").value.trim(),
    employees: document.getElementById("f-employees").value.trim(),
    channel: document.getElementById("f-channel").value,
    warmth: document.getElementById("f-warmth").value,
    source: document.getElementById("f-source").value,
    stage: document.getElementById("f-stage").value,
    nextAction: document.getElementById("f-nextAction").value.trim(),
    nextActionDate: document.getElementById("f-nextActionDate").value,
    notes: document.getElementById("f-notes").value.trim(),
  };
}

function openAddProspect() {
  openModal("Add Prospect", prospectFormHtml(null), true);
}

function saveNewProspect() {
  const d = getFormData();
  if (!d.company || !d.contact) return;
  prospects.unshift({ ...d, id: genId(), createdAt: todayStr(), stageDate: todayStr(), history: [] });
  saveProspects(prospects);
  closeModal();
  refreshCurrentView();
}

function openEditProspect(id) {
  const p = prospects.find(x=>x.id===id);
  if (!p) return;
  openModal("Edit Prospect", prospectFormHtml(p), true);
}

function saveEditProspect(id) {
  const d = getFormData();
  if (!d.company || !d.contact) return;
  const idx = prospects.findIndex(x=>x.id===id);
  if (idx === -1) return;
  prospects[idx] = { ...prospects[idx], ...d };
  saveProspects(prospects);
  closeModal();
  refreshCurrentView();
}

function deleteProspect(id) {
  if (!confirm("Delete this prospect?")) return;
  prospects = prospects.filter(p=>p.id!==id);
  saveProspects(prospects);
  refreshCurrentView();
}

function advanceStage(id) {
  const p = prospects.find(x=>x.id===id);
  if (!p) return;
  const idx = stageIdx(p.stage);
  if (idx >= STAGES.length - 1) return;
  const next = STAGES[idx+1];
  const followDays = FOLLOW_UP_DAYS[next.id];
  p.stage = next.id;
  p.stageDate = todayStr();
  if (followDays) p.nextActionDate = futureDate(followDays);
  p.nextAction = next.id==="follow_up_1"?"Send follow-up":next.id==="follow_up_2"?"Final follow-up":
    next.id==="meeting_booked"?"Prep meeting agenda":next.id==="proposal_sent"?"Follow up on proposal":"";
  p.history = [...(p.history||[]), {stage: STAGES[idx].id, date: todayStr()}];
  saveProspects(prospects);
  refreshCurrentView();
}

// â”€â”€â”€ TEMPLATES MODALS â”€â”€â”€

function templateFormHtml(t) {
  const isEdit = !!t;
  t = t || {name:"",channel:"linkedin",subject:"",body:""};
  const vars = ["{{first_name}}","{{company}}","{{company_observation}}","{{pain_point_insight}}","{{specific_topic}}","{{relevant_case_study}}"];
  return `
    <div style="display:flex;gap:10px;margin-bottom:14px">
      <div style="flex:1"><label class="form-label">Template Name</label><input class="input" id="ft-name" value="${escHtml(t.name)}"></div>
      <div style="width:160px"><label class="form-label">Channel</label><select class="input" id="ft-channel">
        ${CHANNELS.map(c=>`<option value="${c.id}" ${t.channel===c.id?'selected':''}>${c.label}</option>`).join("")}
      </select></div>
    </div>
    <div style="margin-bottom:14px" id="ft-subject-wrap">
      <label class="form-label">Subject Line</label><input class="input" id="ft-subject" value="${escHtml(t.subject||"")}">
    </div>
    <div style="margin-bottom:10px"><label class="form-label">Message Body</label>
      <textarea class="input" id="ft-body" style="min-height:200px;font-family:var(--mono);font-size:13px;line-height:1.7">${escHtml(t.body)}</textarea>
    </div>
    <div class="var-buttons">
      ${vars.map(v=>`<button class="var-btn" onclick="document.getElementById('ft-body').value+=\`${v}\`">${v}</button>`).join("")}
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" onclick="${isEdit?`saveEditTemplate('${t.id}')`:'saveNewTemplate()'}">Save Template</button>
    </div>`;
}

function openAddTemplate() { openModal("New Template", templateFormHtml(null), true); }
function openEditTemplate(id) {
  const t = templates.find(x=>x.id===id);
  if(t) openModal("Edit Template", templateFormHtml(t), true);
}

function saveNewTemplate() {
  const d = { name: document.getElementById("ft-name").value.trim(), channel: document.getElementById("ft-channel").value,
    subject: document.getElementById("ft-subject").value.trim(), body: document.getElementById("ft-body").value };
  if (!d.name || !d.body) return;
  templates.push({ ...d, id: genId() });
  saveTemplates(templates);
  closeModal();
  refreshCurrentView();
}

function saveEditTemplate(id) {
  const idx = templates.findIndex(x=>x.id===id);
  if(idx===-1) return;
  templates[idx] = { ...templates[idx],
    name: document.getElementById("ft-name").value.trim(), channel: document.getElementById("ft-channel").value,
    subject: document.getElementById("ft-subject").value.trim(), body: document.getElementById("ft-body").value };
  saveTemplates(templates);
  closeModal();
  refreshCurrentView();
}

function deleteTemplate(id) {
  if (!confirm("Delete this template?")) return;
  templates = templates.filter(t=>t.id!==id);
  saveTemplates(templates);
  refreshCurrentView();
}

// â”€â”€â”€ API KEY â”€â”€â”€

function loadApiKey() {
  try { return localStorage.getItem("pipeline_api_key") || ""; } catch { return ""; }
}
function saveApiKey(val) {
  localStorage.setItem("pipeline_api_key", val.trim());
  const status = document.getElementById("api-key-status");
  if (val.trim().startsWith("sk-ant-")) {
    status.textContent = "âœ“ Key saved";
    status.style.color = "var(--green)";
  } else if (val.trim()) {
    status.textContent = "Doesn't look right...";
    status.style.color = "var(--accent)";
  } else {
    status.textContent = "";
  }
}

// Init API key field on load
setTimeout(() => {
  const key = loadApiKey();
  const el = document.getElementById("api-key-input");
  if (el && key) { el.value = key; saveApiKey(key); }
}, 100);

// â”€â”€â”€ SENT MESSAGE HISTORY â”€â”€â”€

function loadSentMessages() {
  try { return JSON.parse(localStorage.getItem("pipeline_sent_messages")) || {}; } catch { return {}; }
}
function saveSentMessage(prospectId, msg) {
  const all = loadSentMessages();
  if (!all[prospectId]) all[prospectId] = [];
  all[prospectId].push({ ...msg, sentAt: new Date().toISOString() });
  localStorage.setItem("pipeline_sent_messages", JSON.stringify(all));
}
function getSentMessages(prospectId) {
  return loadSentMessages()[prospectId] || [];
}

// â”€â”€â”€ COMPOSE MODAL â”€â”€â”€

function openCompose(id) {
  const p = prospects.find(x=>x.id===id);
  if(!p) return;
  const relevantTemplates = templates.filter(t=>t.channel===p.channel);
  const first = relevantTemplates[0];
  const firstName = (p.contact||"").split(" ")[0];
  const hasApiKey = !!loadApiKey();
  const sentMsgs = getSentMessages(id);
  const isFollowUp = sentMsgs.length > 0;

  function fillBody(t) {
    if(!t) return "";
    return t.body.replace(/\{\{first_name\}\}/g, firstName).replace(/\{\{company\}\}/g, p.company||"");
  }
  function fillSubject(t) {
    if(!t||!t.subject) return "";
    return t.subject.replace(/\{\{first_name\}\}/g, firstName).replace(/\{\{company\}\}/g, p.company||"");
  }

  const html = `
    <div class="compose-to">
      <span class="compose-to-label">To:</span>
      <span class="compose-to-name">${escHtml(p.contact)}</span>
      ${channelBadge(p.channel)}
      <span class="compose-to-company">${escHtml(p.company)}</span>
      ${p.email ? `<span style="font-size:12px;color:var(--text-muted);font-family:var(--mono)">${escHtml(p.email)}</span>` : ""}
    </div>

    ${isFollowUp ? `<div style="margin-bottom:14px;padding:10px 14px;background:var(--bg-base);border-radius:8px;border-left:3px solid var(--purple)">
      <div style="font-size:11px;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px">Previous message${sentMsgs.length>1?'s':''} (${sentMsgs.length})</div>
      <div style="font-size:12px;color:var(--text-muted);line-height:1.5;white-space:pre-wrap;max-height:80px;overflow:auto;font-family:var(--mono)">${escHtml(sentMsgs[sentMsgs.length-1].body.substring(0,300))}${sentMsgs[sentMsgs.length-1].body.length>300?'...':''}</div>
    </div>` : ''}

    <!-- AI DRAFTING SECTION -->
    <div class="ai-section" id="ai-section">
      <div class="ai-section-header"><span>âœ¦</span> Draft with Claude ${isFollowUp ? '<span style="font-size:10px;background:var(--purple);color:#fff;padding:1px 6px;border-radius:3px;margin-left:6px;text-transform:none;letter-spacing:0">Follow-up mode</span>' : ''}</div>
      ${hasApiKey ? `
        <textarea class="ai-context-input" id="ai-context" placeholder="Optional: add context or a specific angle you want to take.\nClaude will also research the prospect automatically.">${escHtml(p.notes||"")}</textarea>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn-ai" id="ai-draft-btn" onclick="aiResearchAndDraft('${p.id}')">âœ¦ Research & Draft</button>
          <span class="ai-status" id="ai-status"></span>
        </div>
        <div id="ai-research-results" style="display:none"></div>
        <div id="ai-variants" style="display:none"></div>
      ` : `
        <p style="font-size:13px;color:var(--text-muted);line-height:1.6;margin:0">Add your Anthropic API key in the sidebar to enable AI-powered research + message drafting.</p>
      `}
    </div>

    <div style="margin-bottom:14px"><label class="form-label">Template (manual)</label>
      <select class="input" id="compose-template" onchange="fillComposeTemplate('${p.id}')">
        <option value="">Blank</option>
        ${relevantTemplates.map(t=>`<option value="${t.id}">${escHtml(t.name)}</option>`).join("")}
      </select>
    </div>
    ${p.channel==="email" ? `<div style="margin-bottom:14px"><label class="form-label">Subject</label><input class="input" id="compose-subject" value=""></div>` : ""}
    <div style="margin-bottom:14px"><label class="form-label">Message</label>
      <textarea class="input" id="compose-body" style="min-height:200px;line-height:1.7"></textarea>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn-secondary" onclick="copyCompose()">ğŸ“‹ Copy</button>
      ${p.channel==="email" ? `<button class="btn-email" onclick="openInEmail('${p.id}')">âœ‰ Open in Mail</button>` : `<a class="btn-email" style="background:#0A66C2" href="${escHtml(p.linkedin||'https://linkedin.com')}" target="_blank" rel="noopener">â†— Open LinkedIn</a>`}
      <button class="btn-primary" onclick="sendCompose('${p.id}')">Mark Sent & Advance â†’</button>
    </div>`;

  openModal("Compose Message", html, true);
}

// â”€â”€â”€ AI: RESEARCH THEN DRAFT â”€â”€â”€

async function aiResearchAndDraft(prospectId) {
  const apiKey = loadApiKey();
  if (!apiKey) return;

  const p = prospects.find(x=>x.id===prospectId);
  if (!p) return;

  const contextEl = document.getElementById("ai-context");
  const extraContext = contextEl ? contextEl.value.trim() : "";
  const btn = document.getElementById("ai-draft-btn");
  const status = document.getElementById("ai-status");
  const researchDiv = document.getElementById("ai-research-results");
  const variantsDiv = document.getElementById("ai-variants");

  btn.disabled = true;
  btn.textContent = "Researching...";
  status.innerHTML = '<div class="ai-spinner"></div> Searching for recent info on ' + escHtml(p.contact) + '...';
  researchDiv.style.display = "none";
  variantsDiv.style.display = "none";

  const isEmail = p.channel === "email";
  const sentMsgs = getSentMessages(prospectId);
  const isFollowUp = sentMsgs.length > 0;

  try {
    // â•â•â• STEP 1: RESEARCH â•â•â•
    const researchPrompt = `Research this person and their company to find recent, relevant information I can reference in a cold outreach message.

Person: ${p.contact}
Role: ${p.role || "Unknown role"}
Company: ${p.company}
Industry: ${p.industry || "E-commerce"}

IMPORTANT: Focus on information from 2025 or 2026. Anything older than mid-2024 is too stale to reference. Look for:
- Recent articles, case studies, interviews, or talks featuring this person or their company
- Recent company news (product launches, redesigns, milestones, funding, partnerships)
- Their public work or projects (blog posts, conference talks, published case studies)
- What challenges or initiatives they might be focused on given their role

Search for: "${p.contact} ${p.company}" and "${p.company} 2025 2026"

Return your findings as a structured summary. Be specific â€” include dates, titles, and concrete details. If you can't find anything recent and specific about the person, focus on the company. If you truly find nothing relevant and recent, say so honestly.`;

    const researchResponse = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-haiku-4-5-20251001",
        max_tokens: 2048,
        messages: [{ role: "user", content: researchPrompt }],
        tools: [{ type: "web_search_20250305", name: "web_search" }]
      })
    });

    if (!researchResponse.ok) {
      const err = await researchResponse.json().catch(() => ({}));
      throw new Error(err.error?.message || `Research API error ${researchResponse.status}`);
    }

    const researchData = await researchResponse.json();
    const researchText = researchData.content
      .filter(c => c.type === "text")
      .map(c => c.text)
      .join("\n").trim();

    // Show research results
    researchDiv.style.display = "block";
    researchDiv.innerHTML = `
      <div style="margin-top:12px;padding:12px 14px;background:var(--bg-deep);border-radius:8px;border:1px solid var(--border)">
        <div style="font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;display:flex;align-items:center;gap:6px">
          <span>â—</span> Research Findings
        </div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;max-height:200px;overflow:auto">${escHtml(researchText)}</div>
      </div>`;

    // â•â•â• STEP 2: DRAFT VARIANTS â•â•â•
    status.innerHTML = '<div class="ai-spinner"></div> Drafting 3 message variants...';
    btn.textContent = "Drafting...";

    const previousMsgContext = isFollowUp
      ? `\n\nIMPORTANT â€” THIS IS A FOLLOW-UP. Here are the previous messages sent to this person (most recent last):\n${sentMsgs.map((m,i) => `--- Message ${i+1} (${m.sentAt ? new Date(m.sentAt).toLocaleDateString() : 'unknown date'}) ---\n${m.subject ? 'Subject: '+m.subject+'\n' : ''}${m.body}`).join('\n\n')}\n\nWrite a follow-up that:\n- References or builds on the previous message naturally (don't repeat the same pitch)\n- Adds new value â€” a new insight, a relevant finding from the research, or a different angle\n- Is even shorter than the original (under 80 words)\n- Doesn't guilt-trip about not responding`
      : '';

    const draftSystemPrompt = `You are helping Mouslim Benkirane draft ${isFollowUp ? 'a follow-up' : 'a cold outreach'} message. Here is Mouslim's background:

- Senior UX Researcher, PhD in Psychology/Computational Neuroscience from UCLA, MSc from UCL
- Previously led behavioral research at TikTok Shop (30M+ users): studied purchase behavior, trust, retention, recommendation systems
- Key wins: proved trust/quality barriers had higher ROI than frequency tactics (redirected multi-million dollar roadmap); content repetition study changed algorithmic approach
- Now doing independent consulting for e-commerce companies â€” conversion and retention research
- Based in California, originally from Morocco, lived in Sweden/London/LA
- Values: mission-driven companies, ethical work, strong worker treatment

Mouslim's writing style:
- Warm, genuine, human â€” reads like a real person, NOT a consultant pitch
- Leads with curiosity about the prospect's specific work
- VERY concise â€” ${isFollowUp ? 'under 80 words' : 'under 120 words'} for the body, no exceptions
- Signs off as just "Mouslim"
- No bullet points, no bold text, no formatting in the message
- References specific, concrete things from research (not generic praise)
- Low-pressure CTA
- NEVER uses words like "leverage", "synergy", "ecosystem", "unlock", "drive value"`;

    const draftUserPrompt = `Using the research below, draft 3 distinct ${isEmail ? 'cold emails' : 'LinkedIn DMs'} to this prospect. Each should take a DIFFERENT angle based on different findings from the research.

PROSPECT:
Name: ${p.contact} (first name: ${(p.contact||"").split(" ")[0]})
Role: ${p.role || "Unknown"}
Company: ${p.company}
Industry: ${p.industry || "E-commerce"}

RESEARCH FINDINGS:
${researchText}

${extraContext ? `MOUSLIM'S NOTES / ANGLE:\n${extraContext}\n` : ''}${previousMsgContext}

CRITICAL RULES:
- Each message MUST be ${isFollowUp ? 'under 80 words' : 'under 120 words'} (body only, excluding subject). Count carefully.
- Each message should reference something SPECIFIC and RECENT from the research (2025-2026 preferred)
- ${isEmail ? 'Include a subject line for each. Keep subjects under 8 words, intriguing but not clickbaity.' : 'No subject lines â€” these are DMs.'}
- Each variant should feel genuinely different â€” different hook, different angle, different research finding
- Write as Mouslim, sign off as "Mouslim"

FORMAT YOUR RESPONSE EXACTLY LIKE THIS (use these exact delimiters):
===VARIANT 1===
LABEL: [2-4 word label describing the angle, e.g. "Migration case study" or "Design scaling gap"]
${isEmail ? 'SUBJECT: [subject line]\n' : ''}BODY:
[message body]
===VARIANT 2===
LABEL: [different angle label]
${isEmail ? 'SUBJECT: [subject line]\n' : ''}BODY:
[message body]
===VARIANT 3===
LABEL: [different angle label]
${isEmail ? 'SUBJECT: [subject line]\n' : ''}BODY:
[message body]`;

    const draftResponse = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-haiku-4-5-20251001",
        max_tokens: 3000,
        system: draftSystemPrompt,
        messages: [{ role: "user", content: draftUserPrompt }]
      })
    });

    if (!draftResponse.ok) {
      const err = await draftResponse.json().catch(() => ({}));
      throw new Error(err.error?.message || `Draft API error ${draftResponse.status}`);
    }

    const draftData = await draftResponse.json();
    const draftText = draftData.content.map(c => c.text || "").join("\n").trim();

    // Parse variants
    const variants = parseVariants(draftText, isEmail);

    if (variants.length === 0) {
      throw new Error("Couldn't parse message variants. Raw response logged to console.");
    }

    // Show variants
    variantsDiv.style.display = "block";
    variantsDiv.innerHTML = `
      <div style="margin-top:12px">
        <div style="font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px;display:flex;align-items:center;gap:6px">
          <span>âœ¦</span> Choose a variant
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          ${variants.map((v,i) => `
            <div class="ai-variant-card" onclick="selectVariant(${i})" id="variant-card-${i}" style="padding:12px 14px;background:var(--bg-deep);border-radius:8px;border:2px solid var(--border);cursor:pointer;transition:all 0.15s">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <span style="font-size:12px;font-weight:700;color:var(--text-primary)">${escHtml(v.label)}</span>
                <span style="font-size:10px;color:var(--text-muted)">${v.body.split(/\s+/).length} words</span>
              </div>
              ${v.subject ? `<div style="font-size:11px;color:var(--accent);margin-bottom:4px">Subject: ${escHtml(v.subject)}</div>` : ''}
              <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap">${escHtml(v.body)}</div>
            </div>
          `).join("")}
        </div>
      </div>`;

    // Store variants globally for selection
    window._aiVariants = variants;

    // Auto-select first variant
    selectVariant(0);

    status.innerHTML = '<span style="color:var(--green)">âœ“ 3 variants ready â€” click one to use it, then edit as needed</span>';

  } catch (err) {
    console.error("AI Draft Error:", err);
    status.innerHTML = `<span style="color:var(--red)">âœ• ${escHtml(err.message)}</span>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "âœ¦ Research & Draft";
  }
}

function parseVariants(text, isEmail) {
  const variants = [];
  const parts = text.split(/===VARIANT \d+===/i).filter(s => s.trim());

  for (const part of parts) {
    const labelMatch = part.match(/LABEL:\s*(.+)/i);
    const subjectMatch = isEmail ? part.match(/SUBJECT:\s*(.+)/i) : null;
    const bodyMatch = part.match(/BODY:\s*([\s\S]+)/i);

    if (bodyMatch) {
      variants.push({
        label: labelMatch ? labelMatch[1].trim() : `Variant ${variants.length + 1}`,
        subject: subjectMatch ? subjectMatch[1].trim() : "",
        body: bodyMatch[1].trim()
      });
    }
  }
  return variants;
}

function selectVariant(idx) {
  const variants = window._aiVariants;
  if (!variants || !variants[idx]) return;

  const v = variants[idx];
  const bodyEl = document.getElementById("compose-body");
  const subjEl = document.getElementById("compose-subject");
  const tpl = document.getElementById("compose-template");

  if (bodyEl) bodyEl.value = v.body;
  if (subjEl && v.subject) subjEl.value = v.subject;
  if (tpl) tpl.value = "";

  // Highlight selected card
  document.querySelectorAll(".ai-variant-card").forEach((el, i) => {
    el.style.borderColor = i === idx ? "var(--purple)" : "var(--border)";
    el.style.background = i === idx ? "rgba(167,139,250,0.08)" : "var(--bg-deep)";
  });
}

// â”€â”€â”€ OPEN IN EMAIL CLIENT â”€â”€â”€

function openInEmail(prospectId) {
  const p = prospects.find(x=>x.id===prospectId);
  if (!p) return;
  const to = p.email || "";
  const subj = document.getElementById("compose-subject")?.value || "";
  const body = document.getElementById("compose-body")?.value || "";
  const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  window.open(mailto, "_blank");
}

function fillComposeTemplate(prospectId) {
  const p = prospects.find(x=>x.id===prospectId);
  const tid = document.getElementById("compose-template").value;
  const t = templates.find(x=>x.id===tid);
  const firstName = (p.contact||"").split(" ")[0];
  const bodyEl = document.getElementById("compose-body");
  const subjEl = document.getElementById("compose-subject");

  if(!t) { bodyEl.value = ""; if(subjEl) subjEl.value = ""; return; }
  bodyEl.value = t.body.replace(/\{\{first_name\}\}/g, firstName).replace(/\{\{company\}\}/g, p.company||"");
  if(subjEl) subjEl.value = (t.subject||"").replace(/\{\{first_name\}\}/g, firstName).replace(/\{\{company\}\}/g, p.company||"");
}

function copyCompose() {
  const body = document.getElementById("compose-body").value;
  const subj = document.getElementById("compose-subject");
  const text = subj ? `Subject: ${subj.value}\n\n${body}` : body;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    btn.textContent = "âœ“ Copied!";
    setTimeout(() => { btn.textContent = "ğŸ“‹ Copy"; }, 1500);
  });
}

function sendCompose(id) {
  // Save the sent message for follow-up context
  const body = document.getElementById("compose-body")?.value || "";
  const subject = document.getElementById("compose-subject")?.value || "";
  if (body.trim()) {
    saveSentMessage(id, { subject, body });
  }
  advanceStage(id);
  closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISCOVER â€” AI PROSPECT FINDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setDiscoverQuery(text) {
  document.getElementById("discover-query").value = text;
}

async function runDiscover() {
  const apiKey = loadApiKey();
  if (!apiKey) {
    alert("Add your Anthropic API key in the sidebar first.");
    return;
  }

  const query = document.getElementById("discover-query").value.trim();
  if (!query) return;

  const btn = document.getElementById("discover-btn");
  const statusDiv = document.getElementById("discover-status");
  const resultsDiv = document.getElementById("discover-results");

  btn.disabled = true;
  btn.textContent = "Searching...";
  statusDiv.style.display = "block";
  statusDiv.innerHTML = `<div class="discover-status-bar">
    <div class="ai-spinner"></div>
    <span style="color:var(--purple)">Searching the web for prospects matching your criteria...</span>
  </div>`;
  resultsDiv.innerHTML = "";

  const systemPrompt = `You are a prospect research assistant helping Mouslim Benkirane find potential consulting clients. Mouslim is a Senior UX Researcher (PhD, Computational Neuroscience) who consults for e-commerce companies on conversion and retention research.

His ideal client profile:
- Mid-market e-commerce / DTC companies ($10Mâ€“$100M revenue, 50â€“500 employees)
- Companies that care about UX but don't have a dedicated UX research team
- Mission-driven or values-aligned brands are a plus
- Roles to target: VP/Director of Product, UX, Growth, E-commerce, or CX
- US-based preferred but open to global

Signals that a company needs him:
- Recently redesigned or migrated their website (they optimized the tech but haven't done the research)
- Hiring for UX research roles (shows the need exists)
- Publicly discussing conversion or retention challenges
- Recently raised funding and scaling their product/growth org
- Expanding product lines or entering new markets
- High traffic but potentially underperforming conversion

IMPORTANT RULES:
- Only surface information from 2025 or 2026. Anything older is stale.
- Be specific â€” real company names, real people, real facts with sources
- If you're not confident about a person's current role, say so
- For each prospect, identify the SIGNAL â€” the specific recent event or fact that suggests they need UX research right now`;

  const userPrompt = `Search the web and find 5-8 potential consulting prospects matching this description:

"${query}"

For each prospect, use the web to find:
1. The company and what they do
2. A specific person to contact (name + role) â€” look for VP/Director of Product, UX, Growth, E-commerce
3. A recent SIGNAL (2025-2026) that suggests they'd benefit from conversion/retention research
4. Brief company context (size, industry, what makes them interesting)

Search thoroughly â€” try multiple searches to find good matches.

FORMAT YOUR RESPONSE EXACTLY LIKE THIS (use these exact delimiters):

===PROSPECT===
COMPANY: [company name]
CONTACT: [person's full name]
ROLE: [their role/title]
INDUSTRY: [industry]
SIGNAL: [the specific recent event/fact that suggests they need UX research â€” be concrete with dates]
CONTEXT: [2-3 sentences about the company â€” size, what they sell, why they're a good fit]
TAGS: [comma-separated tags like: DTC, mission-driven, recently-funded, hiring-ux, site-redesign, shopify]

Repeat for each prospect found. Find at least 5 if possible.`;

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-haiku-4-5-20251001",
        max_tokens: 4096,
        system: systemPrompt,
        messages: [{ role: "user", content: userPrompt }],
        tools: [{ type: "web_search_20250305", name: "web_search" }]
      })
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error?.message || `API error ${response.status}`);
    }

    const data = await response.json();
    const fullText = data.content
      .filter(c => c.type === "text")
      .map(c => c.text)
      .join("\n").trim();

    const discovered = parseDiscoverResults(fullText);

    if (discovered.length === 0) {
      statusDiv.innerHTML = `<div class="discover-status-bar">
        <span style="color:var(--accent)">âš  Couldn't find structured results. Try a different or more specific query.</span>
      </div>`;
      resultsDiv.innerHTML = `<div style="padding:16px;background:var(--bg-surface);border-radius:8px;font-size:13px;color:var(--text-muted);line-height:1.7;white-space:pre-wrap">${escHtml(fullText)}</div>`;
      return;
    }

    // Check which are already in pipeline
    const existingCompanies = prospects.map(p => p.company.toLowerCase());

    statusDiv.innerHTML = `<div class="discover-status-bar">
      <span style="color:var(--green)">âœ“ Found ${discovered.length} potential prospects</span>
    </div>`;

    resultsDiv.innerHTML = `<div class="discover-results-grid">${discovered.map((d, i) => {
      const alreadyAdded = existingCompanies.includes(d.company.toLowerCase());
      return `<div class="discover-card" id="discover-card-${i}">
        <div class="discover-card-header">
          <div>
            <div class="discover-card-company">${escHtml(d.company)}</div>
            <div class="discover-card-contact">${escHtml(d.contact)}${d.role ? ' Â· ' + escHtml(d.role) : ''}</div>
          </div>
          ${alreadyAdded ? badge("#22C55E", "Already in pipeline") : ""}
        </div>
        <div class="discover-card-signal">
          <div class="discover-card-signal-label">Signal â€” Why now</div>
          <div class="discover-card-signal-text">${escHtml(d.signal)}</div>
        </div>
        <div class="discover-card-context">${escHtml(d.context)}</div>
        <div class="discover-card-tags">
          ${(d.tags||[]).map(t => badge("#636882", t)).join("")}
          ${d.industry ? badge("#4B8BF5", d.industry) : ""}
        </div>
        <div class="discover-card-footer">
          ${alreadyAdded
            ? `<button class="btn-action" disabled style="opacity:0.4">Already added</button>`
            : `<button class="btn-action" onclick="addDiscoveredProspect(${i})">+ Add to Pipeline</button>
               <button class="btn-primary" onclick="addAndCompose(${i})" style="padding:7px 14px;font-size:13px">+ Add & Compose</button>`
          }
        </div>
      </div>`;
    }).join("")}</div>`;

    // Store discovered prospects for adding
    window._discoveredProspects = discovered;

  } catch (err) {
    console.error("Discover Error:", err);
    statusDiv.innerHTML = `<div class="discover-status-bar">
      <span style="color:var(--red)">âœ• ${escHtml(err.message)}</span>
    </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "âœ¦ Find Prospects";
  }
}

function parseDiscoverResults(text) {
  const results = [];
  const parts = text.split(/===PROSPECT===/i).filter(s => s.trim());

  for (const part of parts) {
    const get = (key) => {
      const m = part.match(new RegExp(key + ':\\s*(.+)', 'i'));
      return m ? m[1].trim() : "";
    };
    const company = get("COMPANY");
    const contact = get("CONTACT");
    if (!company) continue;

    results.push({
      company,
      contact: contact || "Unknown",
      role: get("ROLE"),
      industry: get("INDUSTRY"),
      signal: get("SIGNAL"),
      context: get("CONTEXT"),
      tags: get("TAGS").split(",").map(t => t.trim()).filter(Boolean)
    });
  }
  return results;
}

function addDiscoveredProspect(idx) {
  const d = window._discoveredProspects?.[idx];
  if (!d) return;

  const newProspect = {
    id: genId(),
    company: d.company,
    contact: d.contact,
    role: d.role || "",
    email: "",
    linkedin: "",
    industry: d.industry || "E-commerce",
    revenue: "",
    employees: "",
    channel: "email",
    warmth: "cold",
    source: "AI Discovery",
    stage: "researched",
    nextAction: "Research and send first touch",
    nextActionDate: todayStr(),
    notes: `Signal: ${d.signal}\n\nContext: ${d.context}${d.tags.length ? '\n\nTags: ' + d.tags.join(', ') : ''}`,
    createdAt: todayStr(),
    stageDate: todayStr(),
    history: []
  };

  prospects.unshift(newProspect);
  saveProspects(prospects);

  // Update the card to show "added"
  const card = document.getElementById(`discover-card-${idx}`);
  if (card) {
    const footer = card.querySelector(".discover-card-footer");
    if (footer) footer.innerHTML = `<button class="btn-action" disabled style="opacity:0.4;color:var(--green)">âœ“ Added to pipeline</button>`;
  }

  renderNav();
  return newProspect.id;
}

function addAndCompose(idx) {
  const prospectId = addDiscoveredProspect(idx);
  if (prospectId) {
    openCompose(prospectId);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function exportData() {
  const data = { prospects, templates, sentMessages: loadSentMessages(), exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `pipeline-backup-${todayStr()}.json`;
  a.click();
}

function importData(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      if(data.prospects) { prospects = data.prospects; saveProspects(prospects); }
      if(data.templates) { templates = data.templates; saveTemplates(templates); }
      if(data.sentMessages) { localStorage.setItem("pipeline_sent_messages", JSON.stringify(data.sentMessages)); }
      refreshCurrentView();
      alert("Data imported successfully!");
    } catch { alert("Invalid file format."); }
  };
  reader.readAsText(file);
  e.target.value = "";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function refreshCurrentView() {
  renderNav();
  switchView(currentView);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

renderNav();
renderQueue();
</script>
</body>
</html>
